<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭任务打卡系统</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            margin: 0;
            padding: 20px;
            background-color: #f0f8ff;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.2rem;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            background-color: #ecf0f1;
            border: none;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            font-weight: bold;
            color: #34495e;
            transition: all 0.3s;
        }

        .tab.active {
            background-color: #3498db;
            color: white;
        }

        .tab:hover:not(.active) {
            background-color: #bdc3c7;
        }

        .tab-content {
            display: none;
            padding: 25px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            background-color: #fff;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: #3498db;
            outline: none;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            font-weight: bold;
            transition: all 0.3s;
        }

        button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .activity-list {
            margin-top: 25px;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            align-items: center;
            transition: all 0.3s;
        }

        .activity-item:hover {
            background-color: #f8f9fa;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-actions {
            display: flex;
            gap: 8px;
        }

        .activity-actions button {
            padding: 8px 12px;
            font-size: 14px;
        }

        .activity-actions button.edit {
            background-color: #f39c12;
        }

        .activity-actions button.edit:hover {
            background-color: #e67e22;
        }

        .activity-actions button.delete {
            background-color: #e74c3c;
        }

        .activity-actions button.delete:hover {
            background-color: #c0392b;
        }

        .timer-display {
            font-size: 4rem;
            text-align: center;
            margin: 30px 0;
            color: #2c3e50;
            font-family: 'Courier New', monospace;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .timer-controls button {
            font-size: 1.3rem;
            padding: 12px 25px;
            min-width: 120px;
        }

        .timer-controls button.stop {
            background-color: #e74c3c;
        }

        .timer-controls button.stop:hover {
            background-color: #c0392b;
        }

        .current-activity {
            text-align: center;
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #3498db;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        .activity-card {
            background-color: #ecf0f1;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 5px solid #3498db;
        }

        .activity-card:hover {
            background-color: #dfe6e9;
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .activity-card h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.5rem;
        }

        .activity-card p {
            margin-bottom: 0;
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-title {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.8rem;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .sound-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }

        .sound-option:hover {
            background-color: #ecf0f1;
        }

        .sound-option input {
            margin-right: 10px;
        }

        .sound-option label {
            margin-bottom: 0;
            cursor: pointer;
            flex-grow: 1;
        }

        .sound-preview {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .sound-preview:hover {
            background-color: #2980b9;
        }

        .tab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .volume-control {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }

        .volume-control label {
            margin-bottom: 0;
            font-size: 1.1rem;
        }

        .volume-control input[type="range"] {
            width: 150px;
        }

        .music-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .music-controls button {
            font-size: 1rem;
            padding: 10px 15px;
        }

        .background-music-info {
            text-align: center;
            margin-top: 10px;
            font-style: italic;
            color: #7f8c8d;
        }

        /* 新增样式 */
        .activity-card.completed {
            border-left: 5px solid #2ecc71;
            background-color: #e8f8f5;
        }

        .activity-card.not-completed {
            border-left: 5px solid #e74c3c;
            background-color: #fdedec;
        }

        .completed-badge {
            background-color: #2ecc71;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .not-completed-badge {
            background-color: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .progress-container {
            margin: 20px 0;
            background-color: #ecf0f1;
            border-radius: 10px;
            padding: 15px;
        }

        .progress-title {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .progress-bar {
            height: 20px;
            background-color: #bdc3c7;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.5s ease;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 20px;
        }

        .calendar-header {
            font-weight: bold;
            text-align: center;
            padding: 5px;
        }

        .calendar-day {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .calendar-day.has-records {
            background-color: #e8f8f5;
            color: #27ae60;
            font-weight: bold;
        }

        .calendar-day.today {
            border: 2px solid #3498db;
        }

        .calendar-day:hover {
            background-color: #dfe6e9;
        }

        .record-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .record-filter select, .record-filter input {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #bdc3c7;
        }

        .timer-progress {
            height: 10px;
            background-color: #ecf0f1;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .timer-progress-fill {
            height: 100%;
            background-color: #3498db;
            width: 100%;
            transition: width 1s linear;
        }

        .pre-reminder {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { background-color: #f1c40f; }
            50% { background-color: #f39c12; }
            100% { background-color: #f1c40f; }
        }

        .category-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-right: 5px;
            background-color: #e0e0e0;
        }

        .category-learning { background-color: #d4e6f1; color: #2980b9; }
        .category-sports { background-color: #d5f5e3; color: #27ae60; }
        .category-music { background-color: #fadbd8; color: #e74c3c; }
        .category-other { background-color: #fdebd0; color: #f39c12; }
    </style>
</head>

<body>
    <div class="container">
        <h1>🏠 家庭任务打卡系统 ⏰</h1>

        <div class="tabs">
            <button class="tab active" onclick="openTab('settings')">⚙️ 设置</button>
            <button class="tab" onclick="openTab('activities')">📝 活动打卡</button>
            <button class="tab" onclick="openTab('timer')">⏱️ 计时器</button>
            <button class="tab" onclick="openTab('records')">📊 打卡记录</button>
        </div>

        <!-- 设置页 -->
        <div id="settings" class="tab-content active">
            <div class="tab-header">
                <h2>活动设置</h2>
                <button onclick="openSoundModal()">🔊 选择提示音</button>
            </div>

            <div class="form-group">
                <label for="activity-name">活动名称</label>
                <input type="text" id="activity-name" placeholder="例如：阅读、写字、跳绳等">
            </div>
            <div class="form-group">
                <label for="activity-duration">持续时间（分钟）</label>
                <input type="number" id="activity-duration" min="1" value="30">
            </div>
            <div class="form-group">
                <label for="activity-category">活动分类</label>
                <select id="activity-category">
                    <option value="learning">学习</option>
                    <option value="sports">运动</option>
                    <option value="music">音乐</option>
                    <option value="other">其他</option>
                </select>
            </div>
            <button onclick="addActivity()">➕ 添加活动</button>

            <div class="activity-list">
                <h3>已设置的活动</h3>
                <div id="activities-list"></div>
            </div>
        </div>

        <!-- 活动打卡页 -->
        <div id="activities" class="tab-content">
            <div class="tab-header">
                <h2>选择活动开始打卡</h2>
                <button onclick="resetTodayRecords()" style="background-color: #e74c3c;">🔄 重置今日打卡</button>
            </div>
            
            <div class="progress-container">
                <div class="progress-title">
                    <span>今日完成进度</span>
                    <span id="today-progress-text">0/0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="today-progress-bar"></div>
                </div>
            </div>
            
            <div id="activity-cards"></div>
        </div>

        <!-- 计时器页 -->
        <div id="timer" class="tab-content">
            <div id="timer-default" class="current-activity">
                请从活动打卡页选择一个活动开始计时
            </div>
            <div id="timer-active" class="hidden">
                <div class="current-activity" id="current-activity-name">当前活动：阅读</div>
                <div class="timer-display" id="time-display">30:00</div>
                <div class="timer-progress">
                    <div class="timer-progress-fill" id="timer-progress-fill"></div>
                </div>
                <div class="timer-controls">
                    <button id="pause-btn" onclick="toggleTimer()">⏸️ 暂停</button>
                    <button class="stop" onclick="stopTimer()">⏹️ 停止</button>
                </div>

                <!-- 背景音乐控制 -->
                <div class="volume-control">
                    <label for="volume">背景音乐音量:</label>
                    <input type="range" id="volume" min="0" max="1" step="0.1" value="0.5"
                        oninput="changeVolume(this.value)">
                </div>

                <div class="music-controls">
                    <button onclick="playBackgroundMusic()">🎵 播放音乐</button>
                    <button onclick="pauseBackgroundMusic()">⏸️ 暂停音乐</button>
                    <button onclick="stopBackgroundMusic()">⏹️ 停止音乐</button>
                </div>
                <div class="background-music-info">
                    当前播放: <span id="current-music-name">无</span>
                </div>
            </div>
        </div>

        <!-- 打卡记录页 -->
        <div id="records" class="tab-content">
            <h2>打卡记录</h2>
            
            <div class="record-filter">
                <select id="filter-category" onchange="filterRecords()">
                    <option value="all">所有分类</option>
                    <option value="learning">学习</option>
                    <option value="sports">运动</option>
                    <option value="music">音乐</option>
                    <option value="other">其他</option>
                </select>
                <input type="date" id="filter-date" onchange="filterRecords()">
                <button onclick="resetFilters()">重置筛选</button>
            </div>
            
            <div id="records-calendar"></div>
            <div id="records-list"></div>
        </div>
    </div>

    <!-- 提示音选择模态框 -->
    <div id="sound-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">选择提示音和背景音乐</h3>
            <h4>提示音选项</h4>
            <div id="sound-options">
                <!-- 选项将通过JS动态生成 -->
            </div>

            <h4 style="margin-top: 20px;">背景音乐选项</h4>
            <div id="background-music-options">
                <!-- 选项将通过JS动态生成 -->
            </div>

            <div class="modal-buttons">
                <button onclick="closeSoundModal()">取消</button>
                <button onclick="saveSoundPreference()" style="background-color: #2ecc71;">保存</button>
            </div>
        </div>
    </div>

    <!-- 编辑活动模态框 -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">编辑活动</h3>
            <div class="form-group">
                <label for="edit-activity-name">活动名称</label>
                <input type="text" id="edit-activity-name">
            </div>
            <div class="form-group">
                <label for="edit-activity-duration">持续时间（分钟）</label>
                <input type="number" id="edit-activity-duration" min="1">
            </div>
            <div class="form-group">
                <label for="edit-activity-category">活动分类</label>
                <select id="edit-activity-category">
                    <option value="learning">学习</option>
                    <option value="sports">运动</option>
                    <option value="music">音乐</option>
                    <option value="other">其他</option>
                </select>
            </div>
            <input type="hidden" id="edit-activity-id">
            <div class="modal-buttons">
                <button onclick="closeEditModal()">取消</button>
                <button onclick="saveEditedActivity()" style="background-color: #2ecc71;">保存</button>
            </div>
        </div>
    </div>

    <!-- 音频元素将通过JS动态创建 -->
    <div id="audio-container"></div>

    <script>
        // 存储活动数据
        let activities = JSON.parse(localStorage.getItem('activities')) || [];
        // 存储打卡记录
        let records = JSON.parse(localStorage.getItem('records')) || [];
        // 计时器变量
        let timer;
        let remainingTime = 0;
        let currentActivity = null;
        let isPaused = false;
        let totalDuration = 0; // 活动总时长
        // 当前选中的提示音
        let selectedSound = localStorage.getItem('selectedSound') || 'sound1';
        // 当前选中的背景音乐
        let selectedBackgroundMusic = localStorage.getItem('selectedBackgroundMusic') || 'bgmusic1';
        // 正在编辑的活动ID
        let editingActivityId = null;
        // 背景音乐是否正在播放
        let isBackgroundMusicPlaying = false;
        // 背景音乐音量
        let backgroundMusicVolume = parseFloat(localStorage.getItem('backgroundMusicVolume')) || 0.5;
        // 预提醒时间（最后5分钟）
        const PRE_REMINDER_TIME = 5 * 60;

        // 提示音选项
        const soundOptions = [
            { id: 'sound1', name: '经典铃声', url: 'https://www.soundjay.com/buttons/sounds/button-09.mp3' },
            { id: 'sound2', name: '清脆铃声', url: 'https://www.soundjay.com/buttons/sounds/button-10.mp3' },
            { id: 'sound3', name: '学校铃声', url: 'https://www.soundjay.com/buttons/sounds/button-21.mp3' },
            { id: 'sound4', name: '闹钟声', url: 'https://www.soundjay.com/buttons/sounds/button-22.mp3' },
            { id: 'sound5', name: '蜂鸣声', url: 'https://www.soundjay.com/buttons/sounds/button-23.mp3' }
        ];

        // 背景音乐选项
        const backgroundMusicOptions = [
            { id: 'bgmusic1', name: '轻松钢琴曲', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' },
            { id: 'bgmusic2', name: '自然白噪音', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3' },
            { id: 'bgmusic3', name: '古典音乐', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3' },
            { id: 'bgmusic4', name: '冥想音乐', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3' }
        ];

        // 分类选项
        const categoryOptions = [
            { id: 'learning', name: '学习', color: 'category-learning' },
            { id: 'sports', name: '运动', color: 'category-sports' },
            { id: 'music', name: '音乐', color: 'category-music' },
            { id: 'other', name: '其他', color: 'category-other' }
        ];

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function () {
            renderActivitiesList();
            renderActivityCards();
            renderRecords();
            renderCalendar();
            renderSoundOptions();
            renderBackgroundMusicOptions();
            createAudioElements();
            updateTodayProgress();

            // 初始化音量控制
            document.getElementById('volume').value = backgroundMusicVolume;
            
            // 设置日期筛选器默认为今天
            const today = new Date();
            document.getElementById('filter-date').valueAsDate = today;
        });

        // 创建音频元素
        function createAudioElements() {
            const container = document.getElementById('audio-container');
            container.innerHTML = '';

            // 创建提示音元素
            soundOptions.forEach(sound => {
                const audio = document.createElement('audio');
                audio.id = `audio-${sound.id}`;
                audio.src = sound.url;
                audio.preload = 'auto';
                container.appendChild(audio);
            });

            // 创建背景音乐元素
            backgroundMusicOptions.forEach(music => {
                const audio = document.createElement('audio');
                audio.id = `audio-${music.id}`;
                audio.src = music.url;
                audio.preload = 'auto';
                audio.loop = true;
                audio.volume = backgroundMusicVolume;
                container.appendChild(audio);
            });
        }

        // 切换标签页
        function openTab(tabName) {
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }

            const tabs = document.getElementsByClassName('tab');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }

            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            
            // 如果切换到记录页，更新日历
            if (tabName === 'records') {
                renderCalendar();
            }
        }

        // 添加活动
        function addActivity() {
            const nameInput = document.getElementById('activity-name');
            const durationInput = document.getElementById('activity-duration');
            const categoryInput = document.getElementById('activity-category');

            const name = nameInput.value.trim();
            const duration = parseInt(durationInput.value);
            const category = categoryInput.value;

            if (!name) {
                alert('请输入活动名称');
                return;
            }

            if (isNaN(duration) || duration <= 0) {
                alert('请输入有效的持续时间');
                return;
            }

            const activity = {
                id: Date.now(),
                name: name,
                duration: duration,
                category: category
            };

            activities.push(activity);
            saveActivities();

            nameInput.value = '';
            durationInput.value = '30';
            categoryInput.value = 'learning';

            renderActivitiesList();
            renderActivityCards();
        }

        // 删除活动
        function deleteActivity(id) {
            if (confirm('确定要删除这个活动吗？')) {
                activities = activities.filter(activity => activity.id !== id);
                saveActivities();
                renderActivitiesList();
                renderActivityCards();
            }
        }

        // 打开编辑活动模态框
        function openEditModal(id) {
            const activity = activities.find(a => a.id === id);
            if (!activity) return;

            document.getElementById('edit-activity-name').value = activity.name;
            document.getElementById('edit-activity-duration').value = activity.duration;
            document.getElementById('edit-activity-category').value = activity.category;
            document.getElementById('edit-activity-id').value = id;
            editingActivityId = id;

            document.getElementById('edit-modal').style.display = 'flex';
        }

        // 关闭编辑活动模态框
        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            editingActivityId = null;
        }

        // 保存编辑后的活动
        function saveEditedActivity() {
            const id = parseInt(document.getElementById('edit-activity-id').value);
            const name = document.getElementById('edit-activity-name').value.trim();
            const duration = parseInt(document.getElementById('edit-activity-duration').value);
            const category = document.getElementById('edit-activity-category').value;

            if (!name) {
                alert('请输入活动名称');
                return;
            }

            if (isNaN(duration) || duration <= 0) {
                alert('请输入有效的持续时间');
                return;
            }

            const index = activities.findIndex(a => a.id === id);
            if (index !== -1) {
                activities[index] = {
                    id: id,
                    name: name,
                    duration: duration,
                    category: category
                };

                saveActivities();
                renderActivitiesList();
                renderActivityCards();
                closeEditModal();
            }
        }

        // 保存活动数据
        function saveActivities() {
            localStorage.setItem('activities', JSON.stringify(activities));
        }

        // 渲染活动列表（设置页）
        function renderActivitiesList() {
            const listElement = document.getElementById('activities-list');
            listElement.innerHTML = '';

            if (activities.length === 0) {
                listElement.innerHTML = '<p style="color:#7f8c8d;">暂无活动，请添加活动</p>';
                return;
            }

            activities.forEach(activity => {
                const category = categoryOptions.find(c => c.id === activity.category) || categoryOptions[3];
                
                const item = document.createElement('div');
                item.className = 'activity-item';
                item.innerHTML = `
                    <div>
                        <strong>${activity.name}</strong> 
                        <span class="category-tag ${category.color}">${category.name}</span>
                        - ${activity.duration}分钟
                    </div>
                    <div class="activity-actions">
                        <button class="edit" onclick="openEditModal(${activity.id})">✏️ 编辑</button>
                        <button class="delete" onclick="deleteActivity(${activity.id})">🗑️ 删除</button>
                    </div>
                `;
                listElement.appendChild(item);
            });
        }

        // 渲染活动卡片（打卡页）
        function renderActivityCards() {
            const cardsElement = document.getElementById('activity-cards');
            cardsElement.innerHTML = '';

            if (activities.length === 0) {
                cardsElement.innerHTML = '<p style="color:#7f8c8d;">暂无活动，请先到设置页添加活动</p>';
                return;
            }

            const today = new Date().toLocaleDateString();

            activities.forEach(activity => {
                const card = document.createElement('div');
                
                // 检查今天是否已经打卡
                const isCompleted = records.some(r =>
                    r.activityId === activity.id && r.isToday
                );
                
                // 获取分类信息
                const category = categoryOptions.find(c => c.id === activity.category) || categoryOptions[3];

                card.className = `activity-card ${isCompleted ? 'completed' : 'not-completed'}`;
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3>${activity.name} 
                                <span class="${isCompleted ? 'completed-badge' : 'not-completed-badge'}">
                                    ${isCompleted ? '已完成' : '未完成'}
                                </span>
                            </h3>
                            <p>
                                <span class="category-tag ${category.color}">${category.name}</span>
                                持续时间: ${activity.duration}分钟
                            </p>
                        </div>
                        <div style="font-size: 1.5rem;">
                            ${isCompleted ? '✅' : '❌'}
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => startActivity(activity));
                cardsElement.appendChild(card);
            });
            
            updateTodayProgress();
        }

        // 更新今日进度
        function updateTodayProgress() {
            const todayRecords = records.filter(r => r.isToday);
            const totalActivities = activities.length;
            const completedActivities = todayRecords.length;
            
            document.getElementById('today-progress-text').textContent = 
                `${completedActivities}/${totalActivities}`;
                
            const progressPercent = totalActivities > 0 ? 
                (completedActivities / totalActivities) * 100 : 0;
                
            document.getElementById('today-progress-bar').style.width = 
                `${progressPercent}%`;
        }

        // 添加重置当天打卡记录的函数
        function resetTodayRecords() {
            if (confirm('确定要重置今天的打卡记录吗？此操作不可撤销。')) {
                records.forEach(record => {
                    record.isToday = false;
                });
                localStorage.setItem('records', JSON.stringify(records));
                renderActivityCards();
                renderRecords();
            }
        }

        // 开始活动计时
        function startActivity(activity) {
            currentActivity = activity;
            remainingTime = activity.duration * 60; // 转换为秒
            totalDuration = activity.duration * 60;

            document.getElementById('timer-default').classList.add('hidden');
            document.getElementById('timer-active').classList.remove('hidden');
            document.getElementById('current-activity-name').textContent = `当前活动：${activity.name}`;
            
            // 重置进度条
            document.getElementById('timer-progress-fill').style.width = '100%';
            document.getElementById('timer-progress-fill').classList.remove('pre-reminder');

            updateTimerDisplay();
            startTimer();

            // 自动播放背景音乐
            playBackgroundMusic();

            openTab('timer');
        }

        // 更新计时器显示
        function updateTimerDisplay() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            document.getElementById('time-display').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
            // 更新进度条
            const progressPercent = (remainingTime / totalDuration) * 100;
            document.getElementById('timer-progress-fill').style.width = `${progressPercent}%`;
            
            // 最后5分钟添加预提醒样式
            if (remainingTime <= PRE_REMINDER_TIME && remainingTime > 0) {
                document.getElementById('timer-progress-fill').classList.add('pre-reminder');
            }
        }

        // 开始计时器
        function startTimer() {
            if (timer) clearInterval(timer);
            isPaused = false;
            document.getElementById('pause-btn').textContent = '⏸️ 暂停';

            timer = setInterval(() => {
                if (!isPaused) {
                    remainingTime--;
                    updateTimerDisplay();

                    if (remainingTime <= 0) {
                        clearInterval(timer);
                        timer = null;
                        playAlarm();
                        addRecord(currentActivity);
                        renderRecords();
                        renderActivityCards();

                        // 5秒后自动停止
                        setTimeout(() => {
                            stopTimer();
                            stopBackgroundMusic();
                        }, 5000);
                    }
                }
            }, 1000);
        }

        // 暂停/继续计时器
        function toggleTimer() {
            isPaused = !isPaused;
            document.getElementById('pause-btn').textContent = isPaused ? '▶️ 继续' : '⏸️ 暂停';

            // 同时暂停/继续背景音乐
            if (isPaused) {
                pauseBackgroundMusic();
            } else {
                playBackgroundMusic();
            }
        }

        // 停止计时器
        function stopTimer() {
            if (timer) clearInterval(timer);
            timer = null;
            currentActivity = null;

            document.getElementById('timer-active').classList.add('hidden');
            document.getElementById('timer-default').classList.remove('hidden');
        }

        // 播放提示音
        function playAlarm() {
            const audio = document.getElementById(`audio-${selectedSound}`);
            if (audio) {
                audio.currentTime = 0;
                audio.play();
            }
        }

        // 播放背景音乐
        function playBackgroundMusic() {
            if (currentActivity) {
                const audio = document.getElementById(`audio-${selectedBackgroundMusic}`);
                if (audio) {
                    audio.currentTime = 0;
                    audio.volume = backgroundMusicVolume;
                    audio.play();
                    isBackgroundMusicPlaying = true;
                    updateCurrentMusicName();
                }
            }
        }

        // 暂停背景音乐
        function pauseBackgroundMusic() {
            const audio = document.getElementById(`audio-${selectedBackgroundMusic}`);
            if (audio) {
                audio.pause();
                isBackgroundMusicPlaying = false;
            }
        }

        // 停止背景音乐
        function stopBackgroundMusic() {
            const audio = document.getElementById(`audio-${selectedBackgroundMusic}`);
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
                isBackgroundMusicPlaying = false;
                document.getElementById('current-music-name').textContent = '无';
            }
        }

        // 改变音量
        function changeVolume(volume) {
            backgroundMusicVolume = parseFloat(volume);
            localStorage.setItem('backgroundMusicVolume', backgroundMusicVolume);

            const audio = document.getElementById(`audio-${selectedBackgroundMusic}`);
            if (audio) {
                audio.volume = backgroundMusicVolume;
            }
        }

        // 更新当前播放音乐名称
        function updateCurrentMusicName() {
            const music = backgroundMusicOptions.find(m => m.id === selectedBackgroundMusic);
            if (music) {
                document.getElementById('current-music-name').textContent = music.name;
            }
        }

        // 添加打卡记录
        function addRecord(activity) {
            const today = new Date().toLocaleDateString();
            const now = new Date();
            
            const record = {
                id: Date.now(),
                activityId: activity.id,
                activityName: activity.name,
                activityCategory: activity.category,
                duration: activity.duration,
                date: now.toLocaleString(),
                timestamp: now.getTime(),
                isToday: true
            };

            // 移除同一天同一活动的旧记录
            records = records.filter(r =>
                !(r.activityId === activity.id && r.isToday)
            );

            records.unshift(record);
            localStorage.setItem('records', JSON.stringify(records));

            // 更新活动卡片显示
            renderActivityCards();
            renderRecords();
            renderCalendar();
        }

        // 渲染打卡记录
        function renderRecords() {
            const recordsElement = document.getElementById('records-list');
            recordsElement.innerHTML = '';

            // 获取筛选条件
            const categoryFilter = document.getElementById('filter-category').value;
            const dateFilter = document.getElementById('filter-date').value;
            
            let filteredRecords = [...records];
            
            // 应用分类筛选
            if (categoryFilter !== 'all') {
                filteredRecords = filteredRecords.filter(r => r.activityCategory === categoryFilter);
            }
            
            // 应用日期筛选
            if (dateFilter) {
                const filterDate = new Date(dateFilter).toLocaleDateString();
                filteredRecords = filteredRecords.filter(r => {
                    const recordDate = new Date(r.timestamp).toLocaleDateString();
                    return recordDate === filterDate;
                });
            }

            if (filteredRecords.length === 0) {
                recordsElement.innerHTML = '<p style="color:#7f8c8d;">暂无打卡记录</p>';
                return;
            }

            filteredRecords.forEach(record => {
                const category = categoryOptions.find(c => c.id === record.activityCategory) || categoryOptions[3];
                
                const item = document.createElement('div');
                item.className = 'activity-item';
                item.innerHTML = `
                    <div>
                        <strong>${record.activityName}</strong> 
                        <span class="category-tag ${category.color}">${category.name}</span>
                        - ${record.duration}分钟
                    </div>
                    <div>
                        ${record.date}
                    </div>
                `;
                recordsElement.appendChild(item);
            });
        }
        
        // 渲染日历视图
        function renderCalendar() {
            const calendarElement = document.getElementById('records-calendar');
            calendarElement.innerHTML = '';
            
            // 创建日历标题
            const now = new Date();
            const monthNames = ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"];
            const title = document.createElement('h3');
            title.textContent = `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
            calendarElement.appendChild(title);
            
            // 创建日历网格
            const calendarGrid = document.createElement('div');
            calendarGrid.className = 'calendar';
            
            // 添加星期标题
            const weekdays = ["日", "一", "二", "三", "四", "五", "六"];
            weekdays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // 获取当月第一天和最后一天
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            // 计算第一天是星期几（0-6，0是星期日）
            const firstDayOfWeek = firstDay.getDay();
            
            // 添加空白格子（如果第一天不是星期日）
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                calendarGrid.appendChild(emptyDay);
            }
            
            // 添加日期格子
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(now.getFullYear(), now.getMonth(), day);
                const dateStr = date.toLocaleDateString();
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                // 检查当天是否有记录
                const hasRecords = records.some(r => {
                    const recordDate = new Date(r.timestamp).toLocaleDateString();
                    return recordDate === dateStr;
                });
                
                if (hasRecords) {
                    dayElement.classList.add('has-records');
                }
                
                // 标记今天
                if (date.toLocaleDateString() === new Date().toLocaleDateString()) {
                    dayElement.classList.add('today');
                }
                
                // 点击日期筛选记录
                dayElement.addEventListener('click', () => {
                    document.getElementById('filter-date').valueAsDate = date;
                    filterRecords();
                });
                
                calendarGrid.appendChild(dayElement);
            }
            
            calendarElement.appendChild(calendarGrid);
        }
        
        // 筛选记录
        function filterRecords() {
            renderRecords();
        }
        
        // 重置筛选
        function resetFilters() {
            document.getElementById('filter-category').value = 'all';
            document.getElementById('filter-date').valueAsDate = new Date();
            filterRecords();
        }

        // 打开提示音选择模态框
        function openSoundModal() {
            document.getElementById('sound-modal').style.display = 'flex';
        }

        // 关闭提示音选择模态框
        function closeSoundModal() {
            document.getElementById('sound-modal').style.display = 'none';
        }

        // 渲染提示音选项
        function renderSoundOptions() {
            const optionsContainer = document.getElementById('sound-options');
            optionsContainer.innerHTML = '';

            soundOptions.forEach(sound => {
                const option = document.createElement('div');
                option.className = 'sound-option';
                option.innerHTML = `
                    <input type="radio" id="sound-${sound.id}" name="sound" value="${sound.id}" 
                        ${selectedSound === sound.id ? 'checked' : ''}>
                    <label for="sound-${sound.id}">${sound.name}</label>
                    <button class="sound-preview" onclick="previewSound('${sound.id}')">试听</button>
                `;
                optionsContainer.appendChild(option);
            });
        }

        // 渲染背景音乐选项
        function renderBackgroundMusicOptions() {
            const optionsContainer = document.getElementById('background-music-options');
            optionsContainer.innerHTML = '';

            backgroundMusicOptions.forEach(music => {
                const option = document.createElement('div');
                option.className = 'sound-option';
                option.innerHTML = `
                    <input type="radio" id="music-${music.id}" name="backgroundMusic" value="${music.id}" 
                        ${selectedBackgroundMusic === music.id ? 'checked' : ''}>
                    <label for="music-${music.id}">${music.name}</label>
                    <button class="sound-preview" onclick="previewSound('${music.id}')">试听</button>
                `;
                optionsContainer.appendChild(option);
            });
        }

        // 试听声音
        function previewSound(soundId) {
            const audio = document.getElementById(`audio-${soundId}`);
            if (audio) {
                audio.currentTime = 0;
                audio.volume = soundId.startsWith('bg') ? backgroundMusicVolume : 1.0;
                audio.play();
            }
        }

        // 保存声音偏好
        function saveSoundPreference() {
            const selectedSoundElement = document.querySelector('input[name="sound"]:checked');
            const selectedMusicElement = document.querySelector('input[name="backgroundMusic"]:checked');

            if (selectedSoundElement) {
                selectedSound = selectedSoundElement.value;
                localStorage.setItem('selectedSound', selectedSound);
            }

            if (selectedMusicElement) {
                selectedBackgroundMusic = selectedMusicElement.value;
                localStorage.setItem('selectedBackgroundMusic', selectedBackgroundMusic);

                // 如果正在播放音乐，切换到新的音乐
                if (isBackgroundMusicPlaying) {
                    stopBackgroundMusic();
                    playBackgroundMusic();
                }
            }

            closeSoundModal();
        }
    </script>
</body>

</html>
