<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›·æ³¢ä¸‰å³¡ä¸­å­¦2025å¹´é«˜ä¸€å¹´çº§æœŸæœ«å·ç»Ÿæµ‹æˆç»©ç»Ÿè®¡åˆ†æ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        }

        h1,
        h2,
        h3 {
            color: #0056b3;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
            margin-top: 30px;
        }

        h1 {
            text-align: center;
            font-size: 2em;
        }

        .upload-section {
            text-align: center;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .upload-section input[type="file"] {
            margin-top: 10px;
        }

        .settings-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f1f3f5;
        }

        .settings-section h3 {
            margin-top: 0;
            border-bottom: none;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .settings-grid label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .settings-grid input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }

        .analysis-section {
            display: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: center;
        }

        th {
            background-color: #e9ecef;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f1f3f5;
        }

        .btn {
            padding: 10px 20px;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .download-section {
            margin-top: 20px;
            text-align: center;
        }

        .summary-row {
            background-color: #e6f7ff;
            font-weight: bold;
        }

        .subject-type-selector {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .subject-type-selector label {
            margin-right: 15px;
            font-weight: bold;
        }

        .export-table {
            font-family: Arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 30px;
        }

        .export-table th {
            background-color: #0056b3;
            color: white;
            font-weight: bold;
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .export-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .export-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .export-table tr:hover {
            background-color: #e6f7ff;
        }

        .export-title {
            font-size: 18px;
            font-weight: bold;
            color: #0056b3;
            margin: 20px 0 10px 0;
        }

        @media print {
            body {
                background-color: white;
                margin: 0;
                padding: 0;
            }

            .container {
                box-shadow: none;
                width: 100%;
                margin: 0;
                padding: 10px;
            }

            .btn {
                display: none !important;
            }
        }

        /* PDFå¯¼å‡ºæŒ‰é’®ç‰¹æ®Šæ ·å¼ */
        .download-section .btn:nth-last-child(1) {
            background-color: #dc3545;
            margin-left: 10px;
        }

        .download-section .btn:nth-last-child(1):hover {
            background-color: #bb2d3b;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>é›·æ³¢ä¸‰å³¡ä¸­å­¦2025å¹´é«˜ä¸€å¹´çº§æœŸæœ«å·ç»Ÿæµ‹æˆç»©ç»Ÿè®¡åˆ†æ</h1>

        <div class="upload-section">
            <h2>ä¸Šä¼ æˆç»©è¡¨</h2>
            <p>è¯·ä¸Šä¼ æˆç»©è¡¨æ–‡ä»¶è¿›è¡Œç»Ÿè®¡åˆ†æã€‚</p>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
            <button class="btn" onclick="processFile()">å¼€å§‹åˆ†æ</button>
        </div>
        <!-- æ•™å¸ˆä»»è¯¾è¡¨æ¨¡æ¿ä¸‹è½½ -->
        <div class="upload-section" style="margin-top:30px;">
            <h2>2. ä¸Šä¼ æ•™å¸ˆä»»è¯¾è¡¨ï¼ˆè‡ªåŠ¨åŒ¹é…ç­ä¸»ä»»/ä»»è¯¾æ•™å¸ˆï¼‰</h2>
            <p>è¯·å…ˆä¸‹è½½æ¨¡æ¿ï¼ŒæŒ‰æ ¼å¼å¡«å†™åå†ä¸Šä¼ ã€‚</p>
            <button class="btn" onclick="downloadTeacherTemplate()">ğŸ“¥ ä¸‹è½½æ•™å¸ˆä»»è¯¾è¡¨æ¨¡æ¿</button>
            <input type="file" id="teacherFileInput" accept=".xlsx,.xls" style="margin-left:10px;">
            <button class="btn" onclick="processTeacherFile()">å¼€å§‹å¯¼å…¥</button>
        </div>
        <div class="settings-section" id="settingsSection" style="display: none;">
            <div class="subject-type-selector">
                <label>ç§‘ç›®ç±»å‹ï¼š</label>
                <label><input type="radio" name="subjectType" value="physics" checked> ç‰©ç†ç±»</label>
                <label><input type="radio" name="subjectType" value="history"> å†å²ç±»</label>
            </div>

            <h3>åˆ†æ•°çº¿è®¾ç½®</h3>
            <p>è¯·åœ¨ä¸‹æ–¹æ‰‹åŠ¨è®¾ç½®ç‰¹æ§çº¿å’Œæœ¬ç§‘çº¿ï¼Œç„¶åç‚¹å‡»"åº”ç”¨è®¾ç½®å¹¶åˆ†æ"ã€‚</p>

            <div id="physicsSettings">
                <h4>ç‰©ç†ç±»åˆ†æ•°çº¿</h4>
                <div class="settings-grid">
                    <div>
                        <label for="setTcLine">ç‰¹æ§çº¿ (æ€»åˆ†)</label>
                        <input type="number" id="setTcLine" value="490">
                    </div>
                    <div>
                        <label for="setBkLine">æœ¬ç§‘çº¿ (æ€»åˆ†)</label>
                        <input type="number" id="setBkLine" value="372">
                    </div>
                    <div>
                        <label for="setChineseTc">è¯­æ–‡ç‰¹æ§çº¿</label>
                        <input type="number" id="setChineseTc" value="101">
                    </div>
                    <div>
                        <label for="setChineseBk">è¯­æ–‡æœ¬ç§‘çº¿</label>
                        <input type="number" id="setChineseBk" value="89">
                    </div>
                    <div>
                        <label for="setMathTc">æ•°å­¦ç‰¹æ§çº¿</label>
                        <input type="number" id="setMathTc" value="91">
                    </div>
                    <div>
                        <label for="setMathBk">æ•°å­¦æœ¬ç§‘çº¿</label>
                        <input type="number" id="setMathBk" value="56">
                    </div>
                    <div>
                        <label for="setEnglishTc">è‹±è¯­ç‰¹æ§çº¿</label>
                        <input type="number" id="setEnglishTc" value="98">
                    </div>
                    <div>
                        <label for="setEnglishBk">è‹±è¯­æœ¬ç§‘çº¿</label>
                        <input type="number" id="setEnglishBk" value="60">
                    </div>
                    <div>
                        <label for="setPhysicsTc">ç‰©ç†ç‰¹æ§çº¿</label>
                        <input type="number" id="setPhysicsTc" value="48">
                    </div>
                    <div>
                        <label for="setPhysicsBk">ç‰©ç†æœ¬ç§‘çº¿</label>
                        <input type="number" id="setPhysicsBk" value="25">
                    </div>
                    <div>
                        <label for="setChemistryTc">åŒ–å­¦ç‰¹æ§çº¿</label>
                        <input type="number" id="setChemistryTc" value="83">
                    </div>
                    <div>
                        <label for="setChemistryBk">åŒ–å­¦æœ¬ç§‘çº¿</label>
                        <input type="number" id="setChemistryBk" value="67">
                    </div>
                    <div>
                        <label for="setBiologyTc">ç”Ÿç‰©ç‰¹æ§çº¿</label>
                        <input type="number" id="setBiologyTc" value="85">
                    </div>
                    <div>
                        <label for="setBiologyBk">ç”Ÿç‰©æœ¬ç§‘çº¿</label>
                        <input type="number" id="setBiologyBk" value="70">
                    </div>
                    <div>
                        <label for="setPoliticsTc">æ”¿æ²»ç‰¹æ§çº¿</label>
                        <input type="number" id="setPoliticsTc" value="87">
                    </div>
                    <div>
                        <label for="setPoliticsBk">æ”¿æ²»æœ¬ç§‘çº¿</label>
                        <input type="number" id="setPoliticsBk" value="76">
                    </div>
                    <div>
                        <label for="setGeographyTc">åœ°ç†ç‰¹æ§çº¿</label>
                        <input type="number" id="setGeographyTc" value="86">
                    </div>
                    <div>
                        <label for="setGeographyBk">åœ°ç†æœ¬ç§‘çº¿</label>
                        <input type="number" id="setGeographyBk" value="72">
                    </div>
                </div>
            </div>

            <div id="historySettings" style="display: none;">
                <h4>å†å²ç±»åˆ†æ•°çº¿</h4>
                <div class="settings-grid">
                    <div>
                        <label for="setHistoryTcLine">ç‰¹æ§çº¿ (æ€»åˆ†)</label>
                        <input type="number" id="setHistoryTcLine" value="485">
                    </div>
                    <div>
                        <label for="setHistoryBkLine">æœ¬ç§‘çº¿ (æ€»åˆ†)</label>
                        <input type="number" id="setHistoryBkLine" value="406">
                    </div>
                    <div>
                        <label for="setHistoryChineseTc">è¯­æ–‡ç‰¹æ§çº¿</label>
                        <input type="number" id="setHistoryChineseTc" value="103">
                    </div>
                    <div>
                        <label for="setHistoryChineseBk">è¯­æ–‡æœ¬ç§‘çº¿</label>
                        <input type="number" id="setHistoryChineseBk" value="94">
                    </div>
                    <div>
                        <label for="setHistoryMathTc">æ•°å­¦ç‰¹æ§çº¿</label>
                        <input type="number" id="setHistoryMathTc" value="78">
                    </div>
                    <div>
                        <label for="setHistoryMathBk">æ•°å­¦æœ¬ç§‘çº¿</label>
                        <input type="number" id="setHistoryMathBk" value="50">
                    </div>
                    <div>
                        <label for="setHistoryEnglishTc">è‹±è¯­ç‰¹æ§çº¿</label>
                        <input type="number" id="setHistoryEnglishTc" value="97">
                    </div>
                    <div>
                        <label for="setHistoryEnglishBk">è‹±è¯­æœ¬ç§‘çº¿</label>
                        <input type="number" id="setHistoryEnglishBk" value="68">
                    </div>
                    <div>
                        <label for="setHistoryHistoryTc">å†å²ç‰¹æ§çº¿</label>
                        <input type="number" id="setHistoryHistoryTc" value="59">
                    </div>
                    <div>
                        <label for="setHistoryHistoryBk">å†å²æœ¬ç§‘çº¿</label>
                        <input type="number" id="setHistoryHistoryBk" value="51">
                    </div>
                    <div>
                        <label for="setHistoryPoliticsTc">æ”¿æ²»ç‰¹æ§çº¿</label>
                        <input type="number" id="setHistoryPoliticsTc" value="89">
                    </div>
                    <div>
                        <label for="setHistoryPoliticsBk">æ”¿æ²»æœ¬ç§‘çº¿</label>
                        <input type="number" id="setHistoryPoliticsBk" value="79">
                    </div>
                    <div>
                        <label for="setHistoryGeographyTc">åœ°ç†ç‰¹æ§çº¿</label>
                        <input type="number" id="setHistoryGeographyTc" value="88">
                    </div>
                    <div>
                        <label for="setHistoryGeographyBk">åœ°ç†æœ¬ç§‘çº¿</label>
                        <input type="number" id="setHistoryGeographyBk" value="79">
                    </div>
                </div>
            </div>

            <button class="btn" onclick="applySettingsAndAnalyze()">åº”ç”¨è®¾ç½®å¹¶åˆ†æ</button>
        </div>

        <div id="analysisContent" class="analysis-section">
            <div class="subject-type-selector">
                <label>å½“å‰åˆ†æç§‘ç›®ç±»å‹ï¼š</label>
                <span id="currentSubjectTypeDisplay">ç‰©ç†ç±»</span>
            </div>

            <!-- æ€»ä½“æƒ…å†µè¡¨ -->
            <h2>1. æ€»ä½“æƒ…å†µè¡¨</h2>
            <div id="overallTableContainer"></div>

            <!-- åˆ†ç­çº§ç»¼åˆåˆ†æ -->
            <h2>2. åˆ†ç­çº§ç»¼åˆåˆ†æ</h2>
            <div id="classAnalysisContainer"></div>

            <!-- ç‰¹æ§çº¿ä¸Šçº¿åˆ†æ -->
            <h2>3. ç‰¹æ§çº¿ä¸Šçº¿åˆ†æ</h2>
            <div id="tcAnalysisContainer"></div>

            <!-- æœ¬ç§‘çº¿ä¸Šçº¿åˆ†æ -->
            <h2>4. æœ¬ç§‘çº¿ä¸Šçº¿åˆ†æ</h2>
            <div id="bkAnalysisContainer"></div>

            <!-- æ€»åˆ†åˆ†æ•°æ®µç»Ÿè®¡ -->
            <h2>5. æ€»åˆ†åˆ†æ•°æ®µç»Ÿè®¡</h2>
            <div id="scoreSegmentContainer"></div>

            <!-- 6. å„ç­æˆç»©åˆ†æè¡¨ -->
            <h2>6. å„ç­æˆç»©åˆ†æè¡¨</h2>
            <div id="classSubjectTableContainer"></div>

            <div class="download-section">
                <button class="btn" onclick="downloadAllAnalysis()">å…¨éƒ¨æ•°æ®ä¸€é”®å¯¼å‡º</button>
                <button class="btn" onclick="exportToPDF()">å¯¼å‡ºPDFæŠ¥å‘Š</button>
                <button class="btn" onclick="downloadTable('overallTableContainer', 'æ€»ä½“æƒ…å†µè¡¨')">ä¸‹è½½æ€»ä½“æƒ…å†µè¡¨</button>
                <button class="btn" onclick="downloadClassSubjectTablesStyled()">
                    ä¸‹è½½å„ç­æˆç»©åˆ†æè¡¨ï¼ˆå¸¦æ ·å¼ï¼‰
                </button>
                <button class="btn" onclick="downloadClassSubjectTables()">ä¸‹è½½å„ç­æˆç»©åˆ†æè¡¨</button>
                <button class="btn" onclick="downloadTable('classAnalysisContainer', 'åˆ†ç­çº§ç»¼åˆåˆ†æ')">ä¸‹è½½åˆ†ç­çº§ç»¼åˆåˆ†æ</button>
                <button class="btn" onclick="downloadTable('tcAnalysisContainer', 'ç‰¹æ§çº¿ä¸Šçº¿åˆ†æ')">ä¸‹è½½ç‰¹æ§çº¿ä¸Šçº¿åˆ†æ</button>
                <button class="btn" onclick="downloadTable('bkAnalysisContainer', 'æœ¬ç§‘çº¿ä¸Šçº¿åˆ†æ')">ä¸‹è½½æœ¬ç§‘çº¿ä¸Šçº¿åˆ†æ</button>
                <button class="btn" onclick="downloadTable('scoreSegmentContainer', 'æ€»åˆ†åˆ†æ•°æ®µç»Ÿè®¡')">ä¸‹è½½æ€»åˆ†åˆ†æ•°æ®µç»Ÿè®¡</button>

            </div>
        </div>
    </div>

    <!-- 1. æ”¯æŒæ ·å¼çš„ç‰ˆæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script> <!-- åœ¨<head>æ ‡ç­¾å†…æ·»åŠ  -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        let studentData = [];
        let settings = {};
        let currentSubjectType = 'physics';
        const physicsSubjects = ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©', 'æ”¿æ²»', 'åœ°ç†'];
        const historySubjects = ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'å†å²', 'æ”¿æ²»', 'åœ°ç†'];
        const fullMarks = {
            è¯­æ–‡: 150, æ•°å­¦: 150, è‹±è¯­: 150, ç‰©ç†: 100, åŒ–å­¦: 100,
            ç”Ÿç‰©: 100, æ”¿æ²»: 100, åœ°ç†: 100, å†å²: 100
        };
        // åœ¨ let currentSubjectType = 'physics'; ä¸‹æ–¹æ·»åŠ 
        let subjectTypeText = 'ç‰©ç†ç±»';   // å…¨å±€å˜é‡ï¼Œä¾›æ‰€æœ‰ä¸‹è½½å‡½æ•°ä½¿ç”¨
        // åˆ‡æ¢ç§‘ç›®ç±»å‹è®¾ç½®æ˜¾ç¤º
        document.querySelectorAll('input[name="subjectType"]').forEach(radio => {
            radio.addEventListener('change', function () {
                currentSubjectType = this.value;
                document.getElementById('physicsSettings').style.display = this.value === 'physics' ? 'block' : 'none';
                document.getElementById('historySettings').style.display = this.value === 'history' ? 'block' : 'none';
            });
        });

        function processFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶ï¼');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];

                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: null });

                    if (jsonData.length === 0) {
                        alert('æ–‡ä»¶æ²¡æœ‰æ•°æ®ï¼');
                        return;
                    }

                    const headers = Object.keys(jsonData[0]);

                    studentData = jsonData.map(row => {
                        let student = {};
                        headers.forEach(header => {
                            const value = row[header];
                            student[header] = typeof value === 'number' ? value :
                                !isNaN(parseFloat(value)) ? parseFloat(value) :
                                    value;
                        });

                        // è®¡ç®—æ€»åˆ†ï¼ˆå››èˆäº”å…¥å–æ•´ï¼‰
                        const subjects = currentSubjectType === 'physics' ? physicsSubjects : historySubjects;
                        let total = 0;
                        subjects.forEach(subject => {
                            if (student[subject] && !isNaN(student[subject])) {
                                total += Number(student[subject]);
                            }
                        });
                        student['æ€»åˆ†'] = Math.round(total);  // å››èˆäº”å…¥å–æ•´

                        return student;
                    }).filter(s => s['å§“å']);
                    // normalizeClassNames();   // â† å…³é”®ï¼šç»Ÿä¸€ç­çº§åç§°

                    document.getElementById('settingsSection').style.display = 'block';
                    alert(`æˆåŠŸè¯»å– ${studentData.length} æ¡å­¦ç”Ÿè®°å½•ï¼è¯·è®¾ç½®åˆ†æ•°çº¿åè¿›è¡Œåˆ†æã€‚`);
                } catch (e) {
                    alert('æ–‡ä»¶è§£æé”™è¯¯: ' + e.message);
                    console.error(e);
                }
            };
            reader.onerror = function () {
                alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼');
            };
            reader.readAsArrayBuffer(file);
        }


        function applySettingsAndAnalyze() {
            // è·å–å½“å‰ç§‘ç›®ç±»å‹
            currentSubjectType = document.querySelector('input[name="subjectType"]:checked').value;
            subjectTypeText = currentSubjectType === 'physics' ? 'ç‰©ç†ç±»' : 'å†å²ç±»';
            document.getElementById('currentSubjectTypeDisplay').textContent = currentSubjectType === 'physics' ? 'ç‰©ç†ç±»' : 'å†å²ç±»';

            // è·å–è®¾ç½®å€¼
            if (currentSubjectType === 'physics') {
                settings = {
                    tcTotal: parseFloat(document.getElementById('setTcLine').value),
                    bkTotal: parseFloat(document.getElementById('setBkLine').value),
                    tc: {
                        è¯­æ–‡: parseFloat(document.getElementById('setChineseTc').value),
                        æ•°å­¦: parseFloat(document.getElementById('setMathTc').value),
                        è‹±è¯­: parseFloat(document.getElementById('setEnglishTc').value),
                        ç‰©ç†: parseFloat(document.getElementById('setPhysicsTc').value),
                        åŒ–å­¦: parseFloat(document.getElementById('setChemistryTc').value),
                        ç”Ÿç‰©: parseFloat(document.getElementById('setBiologyTc').value),
                        æ”¿æ²»: parseFloat(document.getElementById('setPoliticsTc').value),
                        åœ°ç†: parseFloat(document.getElementById('setGeographyTc').value),
                    },
                    bk: {
                        è¯­æ–‡: parseFloat(document.getElementById('setChineseBk').value),
                        æ•°å­¦: parseFloat(document.getElementById('setMathBk').value),
                        è‹±è¯­: parseFloat(document.getElementById('setEnglishBk').value),
                        ç‰©ç†: parseFloat(document.getElementById('setPhysicsBk').value),
                        åŒ–å­¦: parseFloat(document.getElementById('setChemistryBk').value),
                        ç”Ÿç‰©: parseFloat(document.getElementById('setBiologyBk').value),
                        æ”¿æ²»: parseFloat(document.getElementById('setPoliticsBk').value),
                        åœ°ç†: parseFloat(document.getElementById('setGeographyBk').value),
                    },
                    subjects: physicsSubjects
                };
            } else {
                settings = {
                    tcTotal: parseFloat(document.getElementById('setHistoryTcLine').value),
                    bkTotal: parseFloat(document.getElementById('setHistoryBkLine').value),
                    tc: {
                        è¯­æ–‡: parseFloat(document.getElementById('setHistoryChineseTc').value),
                        æ•°å­¦: parseFloat(document.getElementById('setHistoryMathTc').value),
                        è‹±è¯­: parseFloat(document.getElementById('setHistoryEnglishTc').value),
                        å†å²: parseFloat(document.getElementById('setHistoryHistoryTc').value),
                        æ”¿æ²»: parseFloat(document.getElementById('setHistoryPoliticsTc').value),
                        åœ°ç†: parseFloat(document.getElementById('setHistoryGeographyTc').value),
                    },
                    bk: {
                        è¯­æ–‡: parseFloat(document.getElementById('setHistoryChineseBk').value),
                        æ•°å­¦: parseFloat(document.getElementById('setHistoryMathBk').value),
                        è‹±è¯­: parseFloat(document.getElementById('setHistoryEnglishBk').value),
                        å†å²: parseFloat(document.getElementById('setHistoryHistoryBk').value),
                        æ”¿æ²»: parseFloat(document.getElementById('setHistoryPoliticsBk').value),
                        åœ°ç†: parseFloat(document.getElementById('setHistoryGeographyBk').value),
                    },
                    subjects: historySubjects
                };
            }


            // æ‰§è¡Œåˆ†æ
            performAnalysis();
            document.getElementById('analysisContent').style.display = 'block';
            document.getElementById('settingsSection').style.display = 'none';
        }

        function performAnalysis() {
            if (studentData.length === 0) return;

            // ç¡®ä¿æ€»åˆ†æ­£ç¡®
            studentData.forEach(student => {
                const subjects = currentSubjectType === 'physics' ? physicsSubjects : historySubjects;
                let total = 0;
                subjects.forEach(subject => {
                    if (typeof student[subject] === 'number') total += student[subject];
                });
                student['æ€»åˆ†'] = Math.round(total);
            });

            // 1. æ€»ä½“æƒ…å†µè¡¨
            generateOverallTable();
            // 2. åˆ†ç­çº§ç»¼åˆåˆ†æ
            generateClassAnalysis();
            // 3. ç‰¹æ§çº¿ä¸Šçº¿åˆ†æ
            generateTcAnalysis();
            // 4. æœ¬ç§‘çº¿ä¸Šçº¿åˆ†æ
            generateBkAnalysis();
            // 5. æ€»åˆ†åˆ†æ•°æ®µç»Ÿè®¡
            generateScoreSegment();
            // 6. å„ç­æˆç»©åˆ†æè¡¨
            generateClassSubjectTable();
        }

        // è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—å¹³å‡åˆ†
        function calculateAverage(values) {
            const validValues = values.filter(v => typeof v === 'number' && !isNaN(v));
            if (validValues.length === 0) return 0;
            return validValues.reduce((sum, val) => sum + val, 0) / validValues.length;
        }

        // è¾…åŠ©å‡½æ•°ï¼šè·å–æœ€é«˜åˆ†
        function getMax(values) {
            const validValues = values.filter(v => typeof v === 'number' && !isNaN(v));
            if (validValues.length === 0) return 0;
            return Math.max(...validValues);
        }

        // 1. æ€»ä½“æƒ…å†µè¡¨
        function generateOverallTable() {
            const container = document.getElementById('overallTableContainer');
            let html = '<table><thead><tr><th>å­¦ç§‘</th><th>ç»Ÿè®¡äººæ•°</th><th>å¹³å‡åˆ†</th><th>éš¾åº¦ç³»æ•°</th><th>æ»¡åˆ†</th><th>æœ€é«˜åˆ†</th><th>ç‰¹æ§çº¿</th><th>ç‰¹æ§çº¿ä¸Šçº¿äººæ•°</th><th>ç‰¹æ§çº¿ä¸Šçº¿ç‡</th><th>æœ¬ç§‘çº¿</th><th>æœ¬ç§‘çº¿ä¸Šçº¿äººæ•°</th><th>æœ¬ç§‘çº¿ä¸Šçº¿ç‡</th></tr></thead><tbody>';

            // åˆè®¡è¡Œ
            const totalScores = studentData.map(s => s['æ€»åˆ†']);
            const totalCount = studentData.length;
            const totalAverage = calculateAverage(totalScores);
            const totalMax = getMax(totalScores);
            const totalTcCount = studentData.filter(s => s['æ€»åˆ†'] >= settings.tcTotal).length;
            const totalBkCount = studentData.filter(s => s['æ€»åˆ†'] >= settings.bkTotal).length;

            html += `<tr class="summary-row">
                <td>åˆè®¡</td>
                <td>${totalCount}</td>
                <td>${totalAverage.toFixed(2)}</td>
                <td>-</td>
                <td>-</td>
                <td>${totalMax}</td>
                <td>${settings.tcTotal}</td>
                <td>${totalTcCount}</td>
                <td>${(totalTcCount / totalCount * 100).toFixed(2)}%</td>
                <td>${settings.bkTotal}</td>
                <td>${totalBkCount}</td>
                <td>${(totalBkCount / totalCount * 100).toFixed(2)}%</td>
            </tr>`;

            // åˆ†ç§‘ç»Ÿè®¡
            settings.subjects.forEach(subject => {
                const scores = studentData.map(s => s[subject]).filter(s => typeof s === 'number' && !isNaN(s));
                const count = scores.length;
                const average = calculateAverage(scores);
                const max = getMax(scores);
                const tcLine = settings.tc[subject];
                const bkLine = settings.bk[subject];
                const tcCount = scores.filter(s => s >= tcLine).length;
                const bkCount = scores.filter(s => s >= bkLine).length;
                const difficulty = fullMarks[subject] ? (average / fullMarks[subject]).toFixed(2) : '-';

                html += `<tr>
                    <td>${subject}</td>
                    <td>${count}</td>
                    <td>${average.toFixed(2)}</td>
                    <td>${difficulty}</td>
                    <td>${fullMarks[subject] || '-'}</td>
                    <td>${max}</td>
                    <td>${tcLine}</td>
                    <td>${tcCount}</td>
                    <td>${(tcCount / count * 100).toFixed(2)}%</td>
                    <td>${bkLine}</td>
                    <td>${bkCount}</td>
                    <td>${(bkCount / count * 100).toFixed(2)}%</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // 2. åˆ†ç­çº§ç»¼åˆåˆ†æ
        function generateClassAnalysis() {
            const container = document.getElementById('classAnalysisContainer');
            let html = '<table><thead><tr><th>ç­çº§</th><th>ç»Ÿè®¡äººæ•°</th><th>äººå¹³æ€»åˆ†</th>';

            // ä½¿ç”¨å½“å‰ç§‘ç›®ç±»å‹å¯¹åº”çš„ç§‘ç›®åˆ—è¡¨
            const subjectsToShow = currentSubjectType === 'physics' ? physicsSubjects : historySubjects;

            subjectsToShow.forEach(subject => {
                html += `<th>${subject}å¹³å‡åˆ†</th><th>${subject}æœ€é«˜åˆ†</th>`;
            });
            html += '</tr></thead><tbody>';

            const classGroups = {};
            studentData.forEach(student => {
                const className = student['ç­çº§åç§°'] || 'æœªçŸ¥ç­çº§';
                if (!classGroups[className]) {
                    classGroups[className] = [];
                }
                classGroups[className].push(student);
            });

            // å­¦æ ¡åˆè®¡æ•°æ®
            const schoolSummary = {
                count: studentData.length,
                avgTotal: calculateAverage(studentData.map(s => s['æ€»åˆ†'])),
                subjectAvgs: {},
                subjectMaxs: {}
            };

            // ä½¿ç”¨å½“å‰ç§‘ç›®ç±»å‹å¯¹åº”çš„ç§‘ç›®åˆ—è¡¨è®¡ç®—å­¦æ ¡åˆè®¡
            subjectsToShow.forEach(subject => {
                const scores = studentData.map(s => s[subject]).filter(s => typeof s === 'number' && !isNaN(s));
                schoolSummary.subjectAvgs[subject] = calculateAverage(scores);
                schoolSummary.subjectMaxs[subject] = getMax(scores);
            });

            // å„ç­çº§æ•°æ®
            Object.keys(classGroups).sort().forEach(className => {
                const students = classGroups[className];
                const count = students.length;
                const avgTotal = calculateAverage(students.map(s => s['æ€»åˆ†']));

                html += `<tr>
            <td>${className}</td>
            <td>${count}</td>
            <td>${avgTotal.toFixed(2)}</td>`;

                // ä½¿ç”¨å½“å‰ç§‘ç›®ç±»å‹å¯¹åº”çš„ç§‘ç›®åˆ—è¡¨ç”Ÿæˆç­çº§æ•°æ®
                subjectsToShow.forEach(subject => {
                    const scores = students.map(s => s[subject]).filter(s => typeof s === 'number' && !isNaN(s));
                    const avg = calculateAverage(scores);
                    const max = getMax(scores);
                    html += `<td>${avg.toFixed(2)}</td><td>${max}</td>`;
                });

                html += '</tr>';
            });

            // å­¦æ ¡åˆè®¡è¡Œ
            html += `<tr class="summary-row">
        <td>å­¦æ ¡åˆè®¡</td>
        <td>${schoolSummary.count}</td>
        <td>${schoolSummary.avgTotal.toFixed(2)}</td>`;

            subjectsToShow.forEach(subject => {
                html += `<td>${schoolSummary.subjectAvgs[subject].toFixed(2)}</td><td>${schoolSummary.subjectMaxs[subject]}</td>`;
            });

            html += '</tr>';

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // 3. ç‰¹æ§çº¿ä¸Šçº¿åˆ†æ
        function generateTcAnalysis() {
            const container = document.getElementById('tcAnalysisContainer');
            let html = '<table><thead><tr><th>ç­çº§</th><th>ç»Ÿè®¡äººæ•°</th>';
            settings.subjects.forEach(subject => {
                html += `<th>${subject}ç‰¹æ§çº¿(${settings.tc[subject]})</th><th>${subject}ä¸Šçº¿äººæ•°</th><th>${subject}å’Œæ€»åˆ†åŒä¸Šäººæ•°</th>`;
            });
            html += '<th>æ€»åˆ†ç‰¹æ§çº¿</th><th>æ€»åˆ†ä¸Šçº¿äººæ•°</th><th>æ€»åˆ†ä¸Šçº¿ç‡</th></tr></thead><tbody>';

            const classGroups = {};
            studentData.forEach(student => {
                const className = student['ç­çº§åç§°'] || 'æœªçŸ¥ç­çº§';
                if (!classGroups[className]) {
                    classGroups[className] = [];
                }
                classGroups[className].push(student);
            });

            // å­¦æ ¡åˆè®¡æ•°æ®
            const schoolSummary = {
                count: studentData.length,
                subjectTcCounts: {},
                subjectDoubleCounts: {},
                totalTcCount: studentData.filter(s => s['æ€»åˆ†'] >= settings.tcTotal).length
            };

            settings.subjects.forEach(subject => {
                const tcSubject = settings.tc[subject];
                schoolSummary.subjectTcCounts[subject] = studentData.filter(s => s[subject] >= tcSubject).length;
                schoolSummary.subjectDoubleCounts[subject] = studentData.filter(s => s[subject] >= tcSubject && s['æ€»åˆ†'] >= settings.tcTotal).length;
            });

            // å„ç­çº§æ•°æ®
            Object.keys(classGroups).sort().forEach(className => {
                const students = classGroups[className];
                const count = students.length;

                html += `<tr><td>${className}</td><td>${count}</td>`;

                settings.subjects.forEach(subject => {
                    const tcSubject = settings.tc[subject];
                    const subjectUp = students.filter(s => s[subject] >= tcSubject).length;
                    const doubleUp = students.filter(s => s[subject] >= tcSubject && s['æ€»åˆ†'] >= settings.tcTotal).length;
                    html += `<td>${tcSubject}</td><td>${subjectUp}</td><td>${doubleUp}</td>`;
                });

                const totalUp = students.filter(s => s['æ€»åˆ†'] >= settings.tcTotal).length;
                html += `<td>${settings.tcTotal}</td><td>${totalUp}</td><td>${(totalUp / count * 100).toFixed(2)}%</td></tr>`;
            });

            // å­¦æ ¡åˆè®¡è¡Œ
            html += `<tr class="summary-row">
                <td>å­¦æ ¡åˆè®¡</td>
                <td>${schoolSummary.count}</td>`;

            settings.subjects.forEach(subject => {
                html += `<td>${settings.tc[subject]}</td>
                         <td>${schoolSummary.subjectTcCounts[subject]}</td>
                         <td>${schoolSummary.subjectDoubleCounts[subject]}</td>`;
            });

            html += `<td>${settings.tcTotal}</td>
                     <td>${schoolSummary.totalTcCount}</td>
                     <td>${(schoolSummary.totalTcCount / schoolSummary.count * 100).toFixed(2)}%</td>
                     </tr>`;

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // 4. æœ¬ç§‘çº¿ä¸Šçº¿åˆ†æ
        function generateBkAnalysis() {
            const container = document.getElementById('bkAnalysisContainer');
            let html = '<table><thead><tr><th>ç­çº§</th><th>ç»Ÿè®¡äººæ•°</th>';

            // ä½¿ç”¨å½“å‰ç§‘ç›®ç±»å‹å¯¹åº”çš„ç§‘ç›®åˆ—è¡¨
            const subjectsToShow = currentSubjectType === 'physics' ? physicsSubjects : historySubjects;

            subjectsToShow.forEach(subject => {
                html += `<th>${subject}æœ¬ç§‘çº¿(${settings.bk[subject]})</th>
                <th>${subject}ä¸Šçº¿äººæ•°</th>
                <th>${subject}å’Œæ€»åˆ†åŒä¸Šäººæ•°</th>`;
            });

            html += '<th>æ€»åˆ†æœ¬ç§‘çº¿</th><th>æ€»åˆ†ä¸Šçº¿äººæ•°</th><th>æ€»åˆ†ä¸Šçº¿ç‡</th></tr></thead><tbody>';

            const classGroups = {};
            studentData.forEach(student => {
                const className = student['ç­çº§åç§°'] || 'æœªçŸ¥ç­çº§';
                if (!classGroups[className]) {
                    classGroups[className] = [];
                }
                classGroups[className].push(student);
            });

            // å­¦æ ¡åˆè®¡æ•°æ®
            const schoolSummary = {
                count: studentData.length,
                subjectBkCounts: {},
                subjectDoubleCounts: {},
                totalBkCount: 0  // åˆå§‹åŒ–ä¸º0
            };

            // é¢„è®¡ç®—å­¦æ ¡æ€»åˆ†ä¸Šçº¿äººæ•°
            schoolSummary.totalBkCount = studentData.filter(s => {
                return typeof s['æ€»åˆ†'] === 'number' && s['æ€»åˆ†'] >= settings.bkTotal;
            }).length;

            // è®¡ç®—å„ç§‘ç›®ä¸Šçº¿äººæ•°
            subjectsToShow.forEach(subject => {
                const bkSubject = settings.bk[subject] || 0;

                // ç§‘ç›®ä¸Šçº¿äººæ•°
                schoolSummary.subjectBkCounts[subject] = studentData.filter(s => {
                    return typeof s[subject] === 'number' && s[subject] >= bkSubject;
                }).length;

                // ç§‘ç›®å’Œæ€»åˆ†åŒä¸Šçº¿äººæ•°
                schoolSummary.subjectDoubleCounts[subject] = studentData.filter(s => {
                    return typeof s[subject] === 'number' && typeof s['æ€»åˆ†'] === 'number' &&
                        s[subject] >= bkSubject && s['æ€»åˆ†'] >= settings.bkTotal;
                }).length;
            });

            // å„ç­çº§æ•°æ®
            Object.keys(classGroups).sort().forEach(className => {
                const students = classGroups[className];
                const count = students.length;

                html += `<tr><td>${className}</td><td>${count}</td>`;

                // å„ç§‘ç›®æ•°æ®
                subjectsToShow.forEach(subject => {
                    const bkSubject = settings.bk[subject] || 0;

                    // ç§‘ç›®ä¸Šçº¿äººæ•°
                    const subjectUp = students.filter(s => {
                        return typeof s[subject] === 'number' && s[subject] >= bkSubject;
                    }).length;

                    // ç§‘ç›®å’Œæ€»åˆ†åŒä¸Šçº¿äººæ•°
                    const doubleUp = students.filter(s => {
                        return typeof s[subject] === 'number' && typeof s['æ€»åˆ†'] === 'number' &&
                            s[subject] >= bkSubject && s['æ€»åˆ†'] >= settings.bkTotal;
                    }).length;

                    html += `<td>${bkSubject}</td><td>${subjectUp}</td><td>${doubleUp}</td>`;
                });

                // æ€»åˆ†ä¸Šçº¿æ•°æ®
                const totalUp = students.filter(s => {
                    return typeof s['æ€»åˆ†'] === 'number' && s['æ€»åˆ†'] >= settings.bkTotal;
                }).length;

                html += `<td>${settings.bkTotal}</td>
                <td>${totalUp}</td>
                <td>${count > 0 ? (totalUp / count * 100).toFixed(2) : '0.00'}%</td></tr>`;
            });

            // å­¦æ ¡åˆè®¡è¡Œ
            html += `<tr class="summary-row">
        <td>å­¦æ ¡åˆè®¡</td>
        <td>${schoolSummary.count}</td>`;

            subjectsToShow.forEach(subject => {
                html += `<td>${settings.bk[subject]}</td>
                <td>${schoolSummary.subjectBkCounts[subject]}</td>
                <td>${schoolSummary.subjectDoubleCounts[subject]}</td>`;
            });

            html += `<td>${settings.bkTotal}</td>
            <td>${schoolSummary.totalBkCount}</td>
            <td>${schoolSummary.count > 0 ?
                    (schoolSummary.totalBkCount / schoolSummary.count * 100).toFixed(2) : '0.00'}%</td>
            </tr>`;

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // // 5. æ€»åˆ†åˆ†æ•°æ®µç»Ÿè®¡
        function generateScoreSegment() {
            const container = document.getElementById('scoreSegmentContainer');
            const maxScore = Math.max(...studentData.map(s => s['æ€»åˆ†']));
            const minScore = Math.min(...studentData.map(s => s['æ€»åˆ†']));
            const segments = [];

            // ç‰¹æ®Šå¤„ç†299åˆ†ä»¥ä¸‹ä¸ºä¸€æ®µ
            segments.push({ name: "299åˆ†ä»¥ä¸‹", min: 0, max: 299 });

            // ä»300åˆ†å¼€å§‹ï¼Œæ¯20åˆ†ä¸ºä¸€æ®µ
            let lowerBound = 300;
            while (lowerBound <= maxScore) {
                const upperBound = lowerBound + 19;
                segments.push({
                    name: `${lowerBound}-${upperBound}`,
                    min: lowerBound,
                    max: upperBound
                });
                lowerBound = upperBound + 1;
            }

            // ç¡®ä¿æœ€åä¸€æ®µè¦†ç›–åˆ°æœ€é«˜åˆ†
            if (segments.length > 1 && segments[segments.length - 1].max < maxScore) {
                segments.push({
                    name: `${lowerBound}åˆ†ä»¥ä¸Š`,
                    min: lowerBound,
                    max: Infinity
                });
            }

            let html = '<table><thead><tr><th>ç­çº§</th><th>ç»Ÿè®¡äººæ•°</th>';
            segments.forEach(seg => html += `<th>${seg.name}</th>`);
            html += '</tr></thead><tbody>';

            const classGroups = {};
            studentData.forEach(student => {
                const className = student['ç­çº§åç§°'] || 'æœªçŸ¥ç­çº§';
                if (!classGroups[className]) {
                    classGroups[className] = [];
                }
                classGroups[className].push(student);
            });

            // å­¦æ ¡åˆè®¡æ•°æ®
            const schoolSummary = {
                count: studentData.length,
                segmentCounts: {}
            };

            segments.forEach(seg => {
                if (seg.max === Infinity) {
                    schoolSummary.segmentCounts[seg.name] =
                        studentData.filter(s => s['æ€»åˆ†'] >= seg.min).length;
                } else {
                    schoolSummary.segmentCounts[seg.name] =
                        studentData.filter(s => s['æ€»åˆ†'] >= seg.min && s['æ€»åˆ†'] <= seg.max).length;
                }
            });

            // å„ç­çº§æ•°æ®
            Object.keys(classGroups).sort().forEach(className => {
                const students = classGroups[className];
                const count = students.length;

                html += `<tr><td>${className}</td><td>${count}</td>`;

                segments.forEach(seg => {
                    let segmentCount;
                    if (seg.max === Infinity) {
                        segmentCount = students.filter(s => s['æ€»åˆ†'] >= seg.min).length;
                    } else {
                        segmentCount = students.filter(s => s['æ€»åˆ†'] >= seg.min && s['æ€»åˆ†'] <= seg.max).length;
                    }
                    html += `<td>${segmentCount}</td>`;
                });
                html += '</tr>';
            });

            // å­¦æ ¡åˆè®¡è¡Œ
            html += `<tr class="summary-row"><td>å­¦æ ¡åˆè®¡</td><td>${schoolSummary.count}</td>`;
            segments.forEach(seg => {
                html += `<td>${schoolSummary.segmentCounts[seg.name]}</td>`;
            });
            html += '</tr>';

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ä¸‹è½½è¡¨æ ¼ä¸ºExcel
        function downloadTable(containerId, filename) {
            const table = document.querySelector(`#${containerId} table`);
            if (!table) {
                alert('æœªæ‰¾åˆ°å¯ä¸‹è½½çš„è¡¨æ ¼ï¼');
                return;
            }
            const workbook = XLSX.utils.table_to_book(table, { sheet: filename });
            XLSX.writeFile(workbook, `${filename}.xlsx`);
        }

        function downloadAllAnalysis() {
            if (!studentData || studentData.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ å¹¶åˆ†ææ•°æ®ï¼');
                return;
            }

            const subjectTypeText = currentSubjectType === 'physics' ? 'ç‰©ç†ç±»' : 'å†å²ç±»';
            const wb = XLSX.utils.book_new();

            // âœ… å®‰å…¨æå–è¡¨æ ¼æ•°æ®ä¸ºäºŒç»´æ•°ç»„
            function extractCleanTableData(containerId) {
                const rows = [];
                const table = document.querySelector(`#${containerId} table`);
                if (!table) return [];

                table.querySelectorAll('tr').forEach(tr => {
                    const row = [];
                    tr.querySelectorAll('th, td').forEach(cell => {
                        const text = cell.innerText?.trim() ?? '';
                        row.push(text);
                    });
                    // è·³è¿‡ç©ºè¡Œ
                    if (row.length > 0 && row.some(v => v !== '')) {
                        rows.push(row);
                    }
                });
                return rows;
            }

            // âœ… æ·»åŠ è¡¨æ ¼åˆ°å·¥ä½œç°¿
            function addSheet(containerId, sheetName) {
                const data = extractCleanTableData(containerId);
                if (data.length === 0) return;
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            }

            addSheet('overallTableContainer', '1.æ€»ä½“æƒ…å†µè¡¨');
            addSheet('classAnalysisContainer', '2.åˆ†ç­çº§ç»¼åˆåˆ†æ');
            addSheet('tcAnalysisContainer', '3.ç‰¹æ§çº¿ä¸Šçº¿åˆ†æ');
            addSheet('bkAnalysisContainer', '4.æœ¬ç§‘çº¿ä¸Šçº¿åˆ†æ');
            addSheet('scoreSegmentContainer', '5.æ€»åˆ†åˆ†æ•°æ®µç»Ÿè®¡');

            // âœ… å„ç­æˆç»©åˆ†æè¡¨
            const classSubjectContainers = document.querySelectorAll('#classSubjectTableContainer table');
            classSubjectContainers.forEach((table, index) => {
                const rows = [];
                table.querySelectorAll('tr').forEach(tr => {
                    const row = [];
                    tr.querySelectorAll('th, td').forEach(cell => {
                        const text = cell.innerText?.trim() ?? '';
                        row.push(text);
                    });
                    if (row.length > 0 && row.some(v => v !== '')) {
                        rows.push(row);
                    }
                });
                if (rows.length === 0) return;
                const ws = XLSX.utils.aoa_to_sheet(rows);
                const title = table.parentElement.querySelector('h3')?.innerText || `ç­çº§${index + 1}`;
                XLSX.utils.book_append_sheet(wb, `6.${title}`);
            });

            // âœ… å¯¼å‡ºæ–‡ä»¶
            const fileName = `é›·æ³¢ä¸‰å³¡ä¸­å­¦é«˜ä¸€æœŸæœ«ç»Ÿæµ‹åˆ†æ_å…¨éƒ¨æ•°æ®_${subjectTypeText}_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }


        // æ›´æ–°æ ·å¼å‡½æ•°
        function applyExcelStyles(worksheet, subjectTypeText) {
            const styledWorksheet = JSON.parse(JSON.stringify(worksheet));

            // ä¸»æ ‡é¢˜æ ·å¼
            if (!styledWorksheet['A1']) styledWorksheet['A1'] = { t: 's' };
            styledWorksheet['A1'].s = {
                font: { bold: true, sz: 16, color: { rgb: "0056B3" } },
                alignment: { horizontal: "center" }
            };

            // å‰¯æ ‡é¢˜æ ·å¼
            ['A2', 'A3'].forEach(cell => {
                if (!styledWorksheet[cell]) styledWorksheet[cell] = { t: 's' };
                styledWorksheet[cell].s = {
                    font: { sz: 12 },
                    alignment: { horizontal: "left" }
                };
            });

            // ç§‘ç›®ç±»å‹åŠ ç²—
            if (styledWorksheet['A3']) {
                styledWorksheet['A3'].s.font.bold = true;
            }

            return styledWorksheet;
        }


        // ä¿®æ”¹applyExcelStyleså‡½æ•°ï¼Œä½¿å…¶ä¸ä¿®æ”¹è¾“å…¥å‚æ•°
        function applyExcelStyles(worksheet) {
            // åˆ›å»ºæ–°å¯¹è±¡ä»¥é¿å…ä¿®æ”¹åŸworksheet
            const styledWorksheet = JSON.parse(JSON.stringify(worksheet));

            // è®¾ç½®æ ‡é¢˜æ ·å¼
            if (!styledWorksheet['A1'].s) styledWorksheet['A1'].s = {};
            styledWorksheet['A1'].s = {
                font: { bold: true, sz: 16, color: { rgb: "0056B3" } },
                alignment: { horizontal: "center" }
            };

            // è®¾ç½®æ—¶é—´æ ·å¼
            if (!worksheet['A2'].s) worksheet['A2'].s = {};
            worksheet['A2'].s = {
                font: { italic: true, sz: 12 },
                alignment: { horizontal: "right" }
            };

            // è®¾ç½®è¡¨å¤´æ ·å¼
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cell = worksheet[XLSX.utils.encode_cell({ r: 3, c: C })];
                if (cell) {
                    cell.s = {
                        fill: { fgColor: { rgb: "0056B3" } },
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        border: {
                            top: { style: "thin", color: { rgb: "000000" } },
                            bottom: { style: "thin", color: { rgb: "000000" } },
                            left: { style: "thin", color: { rgb: "000000" } },
                            right: { style: "thin", color: { rgb: "000000" } }
                        }
                    };
                }
            }

            // è®¾ç½®æ•°æ®è¡Œæ ·å¼
            for (let R = 4; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell = worksheet[XLSX.utils.encode_cell({ r: R, c: C })];
                    if (cell) {
                        cell.s = {
                            border: {
                                top: { style: "thin", color: { rgb: "DDDDDD" } },
                                bottom: { style: "thin", color: { rgb: "DDDDDD" } },
                                left: { style: "thin", color: { rgb: "DDDDDD" } },
                                right: { style: "thin", color: { rgb: "DDDDDD" } }
                            }
                        };

                        // äº¤æ›¿è¡Œé¢œè‰²
                        if (R % 2 === 0) {
                            cell.s.fill = { fgColor: { rgb: "F2F2F2" } };
                        }
                    }
                }
            }

            return worksheet;
        }

        // å¯¼å‡ºä¸ºPDFå‡½æ•°
        function exportToPDF() {
            if (studentData.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ å¹¶åˆ†ææ•°æ®ï¼');
                return;
            }

            // è·å–å½“å‰ç§‘ç›®ç±»å‹
            const subjectType = document.querySelector('input[name="subjectType"]:checked').value;
            const subjectTypeText = subjectType === 'physics' ? 'ç‰©ç†ç±»' : 'å†å²ç±»';

            // åˆ›å»ºåŠ è½½æç¤º
            const loading = alert('æ­£åœ¨ç”ŸæˆPDFï¼Œè¯·ç¨å€™...');

            // è·å–è¦å¯¼å‡ºçš„å®¹å™¨
            const element = document.querySelector('.container');
            const opt = {
                scale: 2,                     // ç¼©æ”¾æ¯”ä¾‹ï¼Œæé«˜æ¸…æ™°åº¦
                useCORS: true,                // å…è®¸è·¨åŸŸå›¾ç‰‡
                allowTaint: true,             // å…è®¸æ±¡æŸ“å›¾ç‰‡
                logging: false,               // å…³é—­æ—¥å¿—
                backgroundColor: '#FFFFFF'    // ç™½è‰²èƒŒæ™¯
            };

            // ä½¿ç”¨html2canvasè½¬æ¢HTMLä¸ºcanvas
            html2canvas(element, opt).then(canvas => {
                // åˆ›å»ºPDFæ–‡æ¡£
                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png');

                // è®¡ç®—å›¾ç‰‡åœ¨A4çº¸ä¸Šçš„å°ºå¯¸
                const imgWidth = 210; // A4çº¸å®½åº¦(mm)
                const pageHeight = 295; // A4çº¸é«˜åº¦(mm)
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                // ç¬¬ä¸€é¡µ
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // å¦‚æœå†…å®¹è¶…è¿‡ä¸€é¡µï¼Œæ·»åŠ æ–°é¡µ
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // ä¿å­˜PDFæ–‡ä»¶
                pdf.save(`é›·æ³¢ä¸‰å³¡ä¸­å­¦é«˜ä¸€å¹´çº§æœŸæœ«ç»Ÿæµ‹åˆ†æ_${subjectTypeText}_${new Date().toISOString().slice(0, 10)}.pdf`);

                // å…³é—­åŠ è½½æç¤º
                if (loading && loading.close) loading.close();
            }).catch(err => {
                console.error('å¯¼å‡ºPDFå¤±è´¥:', err);
                alert('å¯¼å‡ºPDFå¤±è´¥: ' + err.message);
                if (loading && loading.close) loading.close();
            });
        }

        function generateClassSubjectTable() {
            const container = document.getElementById('classSubjectTableContainer');
            container.innerHTML = '';

            // å½“å‰ç§‘ç›®åˆ—è¡¨ + æ€»åˆ†
            const subjects = (currentSubjectType === 'physics'
                ? ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©', 'æ”¿æ²»', 'åœ°ç†']
                : ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'å†å²', 'æ”¿æ²»', 'åœ°ç†']).concat(['æ€»åˆ†']);

            const classGroups = {};
            studentData.forEach(s => {
                const cls = s['ç­çº§åç§°'] || 'æœªçŸ¥ç­çº§';
                if (!classGroups[cls]) classGroups[cls] = [];
                classGroups[cls].push(s);
            });

            Object.keys(classGroups).sort().forEach(cls => {
                const students = classGroups[cls];
                const classNum = cls.replace(/[^\d]/g, '');
                const clsKey = `é«˜ä¸€${classNum}ç­`;
                const info = teacherMap[clsKey] || {};
                const headTeacher = info.ç­ä¸»ä»» || 'è¯·å¡«å†™';

                // ç”Ÿæˆä»»è¯¾æ•™å¸ˆæ˜ å°„
                const teachers = {};
                subjects.forEach(subject => {
                    teachers[subject] = info.ä»»è¯¾?.[subject] || '';
                });

                let html = `
            <h3>é«˜2025çº§ï¼ˆ${classNum}ï¼‰ç­2025å¹´å·ç»Ÿæµ‹æˆç»©åˆ†æè¡¨ï¼ˆç­ä¸»ä»»ï¼š<span>${headTeacher}</span>ï¼‰</h3>
            <table>
                <thead>
                    <tr>
                        <th>ç»Ÿè®¡</th>
                        ${subjects.map(s => `<th>${s}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>å¹³å‡åˆ†</td>
                        ${subjects.map(s => {
                    const arr = students.map(st => st[s]).filter(v => typeof v === 'number' && v !== 0);
                    const avg = arr.length ? calculateAverage(arr) : 0;
                    return `<td>${avg ? avg.toFixed(2) : '-'}</td>`;
                }).join('')}
                    </tr>
                    <tr>
                        <td>ç‰¹æ§ä¸Šçº¿äººæ•°</td>
                        ${subjects.map(s => {
                    const line = s === 'æ€»åˆ†' ? settings.tcTotal : settings.tc[s];
                    const cnt = students.filter(st => typeof st[s] === 'number' && st[s] >= line).length;
                    return `<td>${cnt}</td>`;
                }).join('')}
                    </tr>
                    <tr>
                        <td>æœ¬ç§‘ä¸Šçº¿äººæ•°</td>
                        ${subjects.map(s => {
                    const line = s === 'æ€»åˆ†' ? settings.bkTotal : settings.bk[s];
                    const cnt = students.filter(st => typeof st[s] === 'number' && st[s] >= line).length;
                    return `<td>${cnt}</td>`;
                }).join('')}
                    </tr>
                    <tr>
                        <td>æœ¬ç§‘+æ€»åˆ†åŒä¸Š</td>
                        ${subjects.map(s => {
                    const subLine = s === 'æ€»åˆ†' ? settings.bkTotal : settings.bk[s];
                    const cnt = students.filter(st =>
                        typeof st[s] === 'number' && st[s] >= subLine &&
                        typeof st['æ€»åˆ†'] === 'number' && st['æ€»åˆ†'] >= settings.bkTotal
                    ).length;
                    return `<td>${cnt}</td>`;
                }).join('')}
                    </tr>
                    <tr>
                        <td>ä»»è¯¾æ•™å¸ˆ</td>
                        ${subjects.map(s => `<td>${teachers[s] || ''}</td>`).join('')}
                    </tr>
                </tbody>
            </table>`;

                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function downloadClassSubjectTables() {
            if (!studentData.length) return alert('æš‚æ— æ•°æ®ï¼');

            const subjects = (currentSubjectType === 'physics'
                ? ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©', 'æ”¿æ²»', 'åœ°ç†']
                : ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'å†å²', 'æ”¿æ²»', 'åœ°ç†']).concat(['æ€»åˆ†']);

            const wb = XLSX.utils.book_new();
            const allData = [];

            // æ€»æ ‡é¢˜
            allData.push([`é›·æ³¢ä¸‰å³¡ä¸­å­¦é«˜2025çº§æœŸæœ«å·ç»Ÿæµ‹å„ç­æˆç»©åˆ†æè¡¨ï¼ˆ${subjectTypeText}ï¼‰`]);
            allData.push([]);
            allData.push([]);

            const classGroups = {};
            studentData.forEach(s => {
                const cls = s['ç­çº§åç§°'];
                if (!classGroups[cls]) classGroups[cls] = [];
                classGroups[cls].push(s);
            });

            let currentRow = 3; // ä»ç¬¬ 4 è¡Œå¼€å§‹ï¼ˆ0 åŸºï¼‰

            const merges = [];

            Object.keys(classGroups).sort().forEach(cls => {
                const students = classGroups[cls];
                const classNum = cls.replace(/[^\d]/g, '');
                const clsKey = `é«˜ä¸€${classNum}ç­`;
                const info = teacherMap[clsKey] || {};
                const headTeacher = info.ç­ä¸»ä»» || 'è¯·å¡«å†™';

                // ç­çº§æ ‡é¢˜
                const title = `é«˜2025çº§ï¼ˆ${classNum}ï¼‰ç­ â€”â€” ç­ä¸»ä»»ï¼š${headTeacher}`;
                allData.push([title]);
                merges.push({ s: { r: currentRow, c: 0 }, e: { r: currentRow, c: subjects.length } });
                currentRow++;

                // è¡¨å¤´
                allData.push(['ç»Ÿè®¡', ...subjects]);
                currentRow++;

                // æ•°æ®è¡Œ
                const rows = [
                    ['å¹³å‡åˆ†', ...subjects.map(s => {
                        const arr = students.map(st => st[s]).filter(v => typeof v === 'number' && v !== 0);
                        const avg = arr.length ? calculateAverage(arr) : 0;
                        return avg ? avg.toFixed(2) : '-';
                    })],
                    ['ç‰¹æ§ä¸Šçº¿äººæ•°', ...subjects.map(s => {
                        const line = s === 'æ€»åˆ†' ? settings.tcTotal : settings.tc[s];
                        return students.filter(st => typeof st[s] === 'number' && st[s] >= line).length;
                    })],
                    ['æœ¬ç§‘ä¸Šçº¿äººæ•°', ...subjects.map(s => {
                        const line = s === 'æ€»åˆ†' ? settings.bkTotal : settings.bk[s];
                        return students.filter(st => typeof st[s] === 'number' && st[s] >= line).length;
                    })],
                    ['æœ¬ç§‘+æ€»åˆ†åŒä¸Š', ...subjects.map(s => {
                        const subLine = s === 'æ€»åˆ†' ? settings.bkTotal : settings.bk[s];
                        return students.filter(st =>
                            typeof st[s] === 'number' && st[s] >= subLine &&
                            typeof st['æ€»åˆ†'] === 'number' && st['æ€»åˆ†'] >= settings.bkTotal
                        ).length;
                    })],
                    ['ä»»è¯¾æ•™å¸ˆ', ...subjects.map(s => info.ä»»è¯¾?.[s] || '')]
                ];

                rows.forEach(row => {
                    allData.push(row);
                    currentRow++;
                });

                // ç­çº§ä¹‹é—´ç©ºä¸¤è¡Œ
                allData.push([]);
                allData.push([]);
                currentRow += 2;
            });

            // åˆ›å»ºå·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(allData);

            // åˆå¹¶å•å…ƒæ ¼
            ws['!merges'] = merges;

            // åˆ—å®½
            ws['!cols'] = Array(subjects.length + 1).fill({ wch: 14 });
            ws['!cols'][0] = { wch: 20 };

            // è¾¹æ¡†ä¸æ ·å¼
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = 0; R <= range.e.r; R++) {
                for (let C = 0; C <= range.e.c; C++) {
                    const cell = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[cell]) ws[cell] = { t: 's', v: '' };
                    ws[cell].s = {
                        border: {
                            top: { style: 'thin', color: { rgb: '000000' } },
                            bottom: { style: 'thin', color: { rgb: '000000' } },
                            left: { style: 'thin', color: { rgb: '000000' } },
                            right: { style: 'thin', color: { rgb: '000000' } }
                        },
                        alignment: { horizontal: 'center', vertical: 'center' }
                    };

                    // è¡¨å¤´åŠ ç²—èƒŒæ™¯
                    if (R === 1 || (ws[cell].v === 'ç»Ÿè®¡') || allData[R]?.[0]?.startsWith('é«˜2025çº§')) {
                        ws[cell].s.fill = { fgColor: { rgb: 'E9ECEF' } };
                        ws[cell].s.font = { bold: true };
                    }

                    // ä¸»æ ‡é¢˜
                    if (R === 0) {
                        ws[cell].s.font = { bold: true, sz: 16, color: { rgb: '0056B3' } };
                        ws[cell].s.alignment = { horizontal: 'center' };
                    }
                }
            }

            // æ·»åŠ å·¥ä½œè¡¨å¹¶å¯¼å‡º
            XLSX.utils.book_append_sheet(wb, ws, 'å„ç­æˆç»©åˆ†ææ€»è¡¨');
            const fileName = `å„ç­æˆç»©åˆ†ææ€»è¡¨_${subjectTypeText}_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }


        /* ========= 1. å…¨å±€å˜é‡ ========= */
        let teacherMap = {};   // ç­çº§ -> {ç­ä¸»ä»», ä»»è¯¾:{å­¦ç§‘:æ•™å¸ˆ}}

        /* ========= 2. ç”Ÿæˆå¹¶ä¸‹è½½æ•™å¸ˆæ¨¡æ¿ ========= */
        /* ç”Ÿæˆå¹¶ä¸‹è½½æ•™å¸ˆä»»è¯¾è¡¨ï¼ˆ20 ç­ Ã— 10 ç§‘ï¼‰ */
        function downloadTeacherTemplate() {
            const classes = Array.from({ length: 20 }, (_, i) => `é«˜ä¸€${i + 1}ç­`);
            const subjects = ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©', 'å†å²', 'åœ°ç†', 'æ”¿æ²»'];
            const header = ['ç­çº§åç§°', 'ç­ä¸»ä»»', ...subjects, 'ä»»è¯¾æ•™å¸ˆ'];
            const rows = [];

            classes.forEach(cls => {
                // æ¯ç­ä¸€è¡Œï¼Œç­ä¸»ä»»å’Œå„å­¦ç§‘å…ˆç•™ç©ºï¼Œç”±ä½¿ç”¨è€…å¡«å†™
                rows.push([cls, '', ...Array(subjects.length).fill(''), '']);
            });

            const ws = XLSX.utils.aoa_to_sheet([header, ...rows]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æ•™å¸ˆä»»è¯¾è¡¨');
            XLSX.writeFile(wb, 'æ•™å¸ˆä»»è¯¾è¡¨æ¨¡æ¿.xlsx');
        }




        /* ========= 3. è§£æä¸Šä¼ çš„æ•™å¸ˆè¡¨ ========= */
        function processTeacherFile() {
            const fileInput = document.getElementById('teacherFileInput');
            const file = fileInput.files[0];
            if (!file) { alert('è¯·å…ˆé€‰æ‹©æ•™å¸ˆä»»è¯¾è¡¨ï¼'); return; }

            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const wb = XLSX.read(e.target.result, { type: 'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(ws, { defval: '' });

                    teacherMap = {};
                    const subjects = ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©', 'å†å²', 'æ”¿æ²»', 'åœ°ç†'];

                    data.forEach(r => {
                        const cls = r['ç­çº§åç§°']?.trim();
                        if (!cls) return;

                        teacherMap[cls] = {
                            ç­ä¸»ä»»: r['ç­ä¸»ä»»']?.trim() || '',
                            ä»»è¯¾: {}
                        };

                        subjects.forEach(sub => {
                            if (r[sub]) {
                                teacherMap[cls].ä»»è¯¾[sub] = r[sub].trim();
                            }
                        });
                    });

                    alert(`æˆåŠŸå¯¼å…¥ ${Object.keys(teacherMap).length} ä¸ªç­çº§çš„æ•™å¸ˆä¿¡æ¯ï¼`);
                    if (document.getElementById('analysisContent').style.display !== 'none') {
                        generateClassSubjectTable(); // é‡æ–°ç”Ÿæˆè¡¨æ ¼å¹¶å›å¡«
                    }
                } catch (err) {
                    alert('æ•™å¸ˆè¡¨è§£æå¤±è´¥ï¼š' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }




        /* ========= 4. å›å¡«ç­ä¸»ä»»/ä»»è¯¾æ•™å¸ˆåˆ°é¡µé¢ ========= */
        function fillTeacherNames() {
            // 1) å„ç­æˆç»©åˆ†æè¡¨
            document.querySelectorAll('#classSubjectTableContainer h3').forEach(h3 => {
                const className = h3.textContent.match(/é«˜2025çº§\((\d+)\)ç­/);
                if (!className) return;
                const clsKey = `é«˜ä¸€${className[1]}ç­`;   // ä¸æ¨¡æ¿ä¿æŒä¸€è‡´
                const info = teacherMap[clsKey];
                if (!info) return;

                // ç­ä¸»ä»»
                const span = h3.querySelector('span');
                if (span && info.ç­ä¸»ä»») span.textContent = info.ç­ä¸»ä»»;

                // ä»»è¯¾æ•™å¸ˆ
                const rowTeacher = h3.nextElementSibling.querySelector('tbody tr:last-child');
                if (!rowTeacher) return;
                [...rowTeacher.children].forEach((td, idx) => {
                    if (idx === 0) return; // é¦–åˆ—æ˜¯â€œä»»è¯¾æ•™å¸ˆâ€
                    const subject = td.closest('table').querySelector('thead th').children[idx]?.textContent;
                    if (subject && info.ä»»è¯¾[subject]) td.textContent = info.ä»»è¯¾[subject];
                });
            });
        }
        /* ç»Ÿä¸€ç­çº§åç§°ä¸ºâ€œé«˜ä¸€Xç­â€æ ¼å¼ */
        function normalizeClassNames() {
            studentData.forEach(stu => {
                let cls = stu['ç­çº§åç§°'];
                if (!cls) return;
                cls = String(cls).trim();

                // å¦‚æœå·²ç»æ˜¯â€œé«˜ä¸€Xç­â€åˆ™è·³è¿‡
                if (/^é«˜ä¸€\d+ç­$/.test(cls)) return;

                // çº¯æ•°å­— -> â€œé«˜ä¸€Xç­â€
                if (/^\d+$/.test(cls)) {
                    stu['ç­çº§åç§°'] = `é«˜ä¸€${cls}ç­`;
                    return;
                }

                // å…¶å®ƒæƒ…å†µï¼šå»æ‰å‰åç©ºæ ¼
                stu['ç­çº§åç§°'] = cls;
            });
        }

        function downloadClassSubjectTablesStyled() {
            if (!studentData.length) return alert('æš‚æ— æ•°æ®ï¼');

            const subjects = (currentSubjectType === 'physics'
                ? ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©', 'æ”¿æ²»', 'åœ°ç†']
                : ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'å†å²', 'æ”¿æ²»', 'åœ°ç†']).concat(['æ€»åˆ†']);

            const wb = XLSX.utils.book_new();
            const allData = [];

            // ä¸»æ ‡é¢˜
            allData.push([`é›·æ³¢ä¸‰å³¡ä¸­å­¦é«˜2025çº§å„ç­æˆç»©åˆ†æè¡¨ï¼ˆ${subjectTypeText}ï¼‰`]);
            allData.push([]);
            allData.push([]);

            const classGroups = {};
            studentData.forEach(s => {
                const cls = s['ç­çº§åç§°'];
                if (!classGroups[cls]) classGroups[cls] = [];
                classGroups[cls].push(s);
            });

            let currentRow = 3; // 0 åŸº

            Object.keys(classGroups).sort().forEach(cls => {
                const students = classGroups[cls];
                const classNum = cls.replace(/[^\d]/g, '');
                const clsKey = `é«˜ä¸€${classNum}ç­`;
                const info = teacherMap[clsKey] || {};
                const headTeacher = info.ç­ä¸»ä»» || 'è¯·å¡«å†™';

                // ç­çº§æ ‡é¢˜
                allData.push([`é«˜2025çº§ï¼ˆ${classNum}ï¼‰ç­ â€”â€” ç­ä¸»ä»»ï¼š${headTeacher}`]);
                allData.push(['ç»Ÿè®¡', ...subjects]);
                allData.push(['å¹³å‡åˆ†', ...subjects.map(s => {
                    const arr = students.map(st => st[s]).filter(v => typeof v === 'number' && v !== 0);
                    const avg = arr.length ? calculateAverage(arr) : 0;
                    return avg ? avg.toFixed(2) : '-';
                })]);
                allData.push(['ç‰¹æ§ä¸Šçº¿äººæ•°', ...subjects.map(s => {
                    const line = s === 'æ€»åˆ†' ? settings.tcTotal : settings.tc[s];
                    return students.filter(st => typeof st[s] === 'number' && st[s] >= line).length;
                })]);
                allData.push(['æœ¬ç§‘ä¸Šçº¿äººæ•°', ...subjects.map(s => {
                    const line = s === 'æ€»åˆ†' ? settings.bkTotal : settings.bk[s];
                    return students.filter(st => typeof st[s] === 'number' && st[s] >= line).length;
                })]);
                allData.push(['æœ¬ç§‘+æ€»åˆ†åŒä¸Š', ...subjects.map(s => {
                    const subLine = s === 'æ€»åˆ†' ? settings.bkTotal : settings.bk[s];
                    return students.filter(st =>
                        typeof st[s] === 'number' && st[s] >= subLine &&
                        typeof st['æ€»åˆ†'] === 'number' && st['æ€»åˆ†'] >= settings.bkTotal
                    ).length;
                })]);
                allData.push(['ä»»è¯¾æ•™å¸ˆ', ...subjects.map(s => info.ä»»è¯¾?.[s] || '')]);

                // ç­çº§ä¹‹é—´ç©ºä¸¤è¡Œ
                allData.push([]);
                allData.push([]);
            });

            // åˆ›å»ºå¸¦æ ·å¼çš„å·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(allData);

            // åˆå¹¶å•å…ƒæ ¼
            const merges = [];
            // ğŸ‘‡ åˆå¹¶ä¸»æ ‡é¢˜ï¼ˆç¬¬ä¸€è¡Œï¼‰
            merges.unshift({ s: { r: 0, c: 0 }, e: { r: 0, c: subjects.length } });
            for (let i = 0; i < allData.length; i++) {
                const row = allData[i];
                if (row.length === 1 && row[0].startsWith('é«˜2025çº§')) {
                    merges.push({ s: { r: i, c: 0 }, e: { r: i, c: subjects.length } });
                }
            }
            ws['!merges'] = merges;

            // åˆ—å®½
            ws['!cols'] = Array(subjects.length + 1).fill({ wch: 14 });
            ws['!cols'][0] = { wch: 20 };

            // æ ·å¼
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = 0; R <= range.e.r; R++) {
                for (let C = 0; C <= range.e.c; C++) {
                    const cell = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[cell]) ws[cell] = { t: 's', v: '' };

                    // åŸºæœ¬æ ·å¼
                    ws[cell].s = {
                        border: {
                            top: { style: 'thin', color: { rgb: '000000' } },
                            bottom: { style: 'thin', color: { rgb: '000000' } },
                            left: { style: 'thin', color: { rgb: '000000' } },
                            right: { style: 'thin', color: { rgb: '000000' } }
                        },
                        alignment: { horizontal: 'center', vertical: 'center' },
                        font: {}
                    };

                    // ä¸»æ ‡é¢˜
                    if (R === 0) {
                        ws[cell].s.font = { bold: true, sz: 16, color: { rgb: '0056B3' } };
                        ws[cell].s.alignment = { horizontal: 'center' };
                    }

                    // ç­çº§æ ‡é¢˜
                    if (allData[R]?.[0]?.startsWith('é«˜2025çº§')) {
                        ws[cell].s.font = { bold: true, sz: 13 };
                        ws[cell].s.alignment = { horizontal: 'center' };
                    }

                    // è¡¨å¤´
                    if (allData[R]?.[0] === 'ç»Ÿè®¡') {
                        ws[cell].s.fill = { fgColor: { rgb: 'E9ECEF' } };
                        ws[cell].s.font = { bold: true };
                    }
                }
            }

            XLSX.utils.book_append_sheet(wb, ws, 'å„ç­æˆç»©åˆ†ææ€»è¡¨');
            const fileName = `å„ç­æˆç»©åˆ†ææ€»è¡¨_å¸¦æ ·å¼_${subjectTypeText}_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

    </script>
</body>

</html>